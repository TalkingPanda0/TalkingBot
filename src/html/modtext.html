<!doctype html>
<html>
  <head>
    <link
      href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div style="display: inline-block">
      <canvas id="editorCanvas"></canvas>
    </div>
    <div class="ql-editor" id="text"></div>
  </body>

  <script src=" https://cdn.jsdelivr.net/npm/fabric@7.0.0/dist/index.min.js "></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <script>
    let data = {};
    const canvas = new fabric.Canvas("editorCanvas", {
      width: 1920,
      height: 1080,
      backgroundColor: "transparent",
    });
    const text = document.getElementById("text");

    const socket = io("/modtext");

    socket.on("refresh", () => {
      window.location.reload();
    });
    socket.on("message", (message) => {
      console.log("GOT MESSAGE:", message);
      text.innerHTML = message;
    });
    socket.on("canvas", (message) => {
      console.log("GOT CANVAS:", message);
      canvas.loadFromJSON(message, applyData).then(() => canvas.renderAll());
    });
    socket.on("data", (newData) => {
      console.log("GOT DATA: ", newData);
      data = JSON.parse(newData);
      canvas.getObjects().forEach((obj) => applyData(null, obj));
    });

    function applyData(_, obj) {
      switch (obj.dataId) {
        case "latest_sub":
          obj.set("text", data.latestSub);
          break;
        case "sub_pfp":
          obj.setSrc(data.latestSubPfp).then(() => canvas.renderAll());
          break;
        case "counter":
          obj.set("text", formatNumber(data.counters[obj.counterName]));
          break;
      }
    }

    function formatNumber(n) {
      return Number.isInteger(n) ? String(n) : String(Number(n.toFixed(2)));
    }
  </script>
  <style>
    * {
      font-family: Arial, Helvetica, sans-serif;
    }
    body {
      color: white;
    }
    .emote {
      width: 21px;
    }
    #text {
      padding: 0px !important;
    }
  </style>
</html>
