<!doctype html>
<html>
  <head>
    <style>
      canvas {
        border: 1px solid #ccc;
      }
      .controls {
        margin-bottom: 10px;
        padding: 10px;
      }
      button {
        background-color: #15171c;
        color: white;
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 5px;
        cursor: pointer;
      }
      body {
        font-family: Arial, sans-serif;
        color-scheme: dark;
        background-color: #15171c;
        color: white;
      }
      #textarea {
        width: 95%;
        height: 50%;
        background-color: #15171c;
        color: white;
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 5px;
        cursor: pointer;
      }
      #canvasContainer {
        position: relative;
        width: 960px; /* 1920 * 0.5 */
        height: 540px; /* 1080 * 0.5 */
        border: 2px solid #333;
      }

      #player {
        position: absolute;
      }

      #editorCanvas {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
      }
      #canvasContainer canvas {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: auto;
        z-index: 1;
      }

      dialog {
        width: 500px;
        border: none;
        border-radius: 6px;
        padding: 16px;
      }

      #imageGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        margin-bottom: 10px;
      }

      #imageGrid img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        cursor: pointer;
        border: 2px solid transparent;
      }

      #imageGrid img:hover {
        border-color: #888;
      }

      .actions {
        text-align: right;
      }
    </style>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@5/dark.css"
    />
    <script src=" https://cdn.jsdelivr.net/npm/fabric@7.0.0/dist/index.min.js "></script>
    <script src="https://player.twitch.tv/js/embed/v1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
  </head>

  <body>
    <div class="controls">
      <button
        class="normalMode material-icons"
        title="Add Text"
        onclick="addText()"
      >
        text_format
      </button>
      <button
        class="normalMode material-icons"
        title="Add Image From URL"
        onclick="addImagePrompt()"
      >
        image_search
      </button>
      <button
        class="normalMode material-icons"
        title="Choose Image"
        onclick="pickImage()"
      >
        image
      </button>
      <button
        class="normalMode material-symbols-outlined"
        title="Add Subscriber Name"
        onclick="addSubName()"
      >
        chess_knightbadge
      </button>
      <button
        class="normalMode  material-symbols-outlined"
        title="Add Subscriber PFP"
        onclick="addSubPfp()"
      >
        chess_knightperson
      </button>
      <button
        class="normalMode material-icons"
        title="Add Counter"
        onclick="addCounter()"
      >
        exposure_plus_1
      </button>
      <button
        class="normalMode material-icons"
        id="playPauseButton"
        title="Play/Pause"
        onclick="playPause()"
      >
        pause
      </button>

      <button
        class="material-icons"
        onclick="getModText()"
        title="Update Mod Text"
      >
        update
      </button>

      <button
        class="material-icons"
        class="button"
        id="button"
        onclick="toggleMode()"
      >
        settings
      </button>

      <button
        class="material-icons"
        onclick="sendToOverlay()"
        style="background: #9146ff; color: white"
      >
        send
      </button>

      <dialog id="imageDialog">
        <form
          id="imageUploadForm"
          action="/control/modtext/addimage"
          method="POST"
          enctype="multipart/form-data"
          method="dialog"
          class="dialog-body"
        >
          <h3>Select an image</h3>

          <div id="imageGrid"></div>

          <hr />

          <label>
            Upload new image:
            <input type="file" name="image" accept="image/*" />
          </label>

          <div class="actions">
            <button type="submit">Upload Image</button>
            <button type="button" id="cancelBtn">Cancel</button>
          </div>
        </form>
      </dialog>
    </div>
    <div
      id="canvasContainer"
      style="border: 2px solid #333; display: inline-block"
    >
      <div id="player"></div>
      <canvas id="editorCanvas"></canvas>
    </div>

    <textarea style="display: none" id="textarea" rows="10"></textarea>
    <script>
      const events = ["object:added", "object:modified", "object:removed"];
      const dialog = document.getElementById("imageDialog");
      const grid = document.getElementById("imageGrid");
      const form = document.getElementById("imageUploadForm");

      fabric.FabricObject.customProperties = ["dataId", "counterName"];
      let data = {};
      const playPauseButton = document.getElementById("playPauseButton");
      const player = new Twitch.Player("player", {
        width: 1920 / 2,
        height: 1080 / 2,
        channel: "sweetbabooo_o",
        parent: ["localhost", "talkingpanda.dev"],
        autoplay: true,
        muted: true,
      });
      const button = document.getElementById("button");
      const textArea = document.getElementById("textarea");
      let mode = false;

      function playPause() {
        if (player.isPaused()) {
          playPauseButton.innerText = "pause";
          player.play();
        } else {
          playPauseButton.innerText = "play";
          player.pause();
        }
      }

      const deleteIcon =
        "data:image/svg+xml,%3C%3Fxml version='1.0' encoding='utf-8'%3F%3E%3C!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3E%3Csvg version='1.1' id='Ebene_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' width='595.275px' height='595.275px' viewBox='200 215 230 470' xml:space='preserve'%3E%3Ccircle style='fill:%23F44336;' cx='299.76' cy='439.067' r='218.516'/%3E%3Cg%3E%3Crect x='267.162' y='307.978' transform='matrix(0.7071 -0.7071 0.7071 0.7071 -222.6202 340.6915)' style='fill:white;' width='65.545' height='262.18'/%3E%3Crect x='266.988' y='308.153' transform='matrix(0.7071 0.7071 -0.7071 0.7071 398.3889 -83.3116)' style='fill:white;' width='65.544' height='262.179'/%3E%3C/g%3E%3C/svg%3E";

      var deleteImg = document.createElement("img");
      deleteImg.src = deleteIcon;
      const normalEditor = document.getElementById("canvasContainer");
      const canvas = new fabric.Canvas("editorCanvas", {
        width: 1920,
        height: 1080,
      });

      const deleteControl = new fabric.Control({
        x: 0.5,
        y: -0.5,
        offsetY: -16,
        offsetX: 16,
        cursorStyle: "pointer",
        mouseUpHandler: deleteObject,
        render: renderIcon,
        cornerSize: 24,
      });

      function deleteObject(_eventData, transform) {
        const canvas = transform.target.canvas;
        canvas.remove(transform.target);
        canvas.requestRenderAll();
      }

      function renderIcon(ctx, left, top, _styleOverride, fabricObject) {
        const size = this.cornerSize;
        ctx.save();
        ctx.translate(left, top);
        ctx.rotate(fabric.util.degreesToRadians(fabricObject.angle));
        ctx.drawImage(deleteImg, -size / 2, -size / 2, size, size);
        ctx.restore();
      }

      canvas.setZoom(0.5);
      canvas.setDimensions({ width: 1920 * 0.5, height: 1080 * 0.5 });

      function addText() {
        const text = new fabric.IText("Type something...", {
          left: 1920 / 2,
          top: 1080 / 2,
          fontFamily: "sans-serif",
          fill: "#ffffff",
        });
        addCustomProperties(text);
        canvas.add(text);
      }

      async function addCounter() {
        const options = Object.fromEntries(
          Object.entries(data.counters).map(([key, value]) => [
            key,
            `${key}: ${value}`,
          ]),
        );
        const { value: counter } = await Swal.fire({
          title: "Select a counter to show",
          input: "select",
          inputOptions: options,
        });
        const text = new fabric.IText(counter, {
          left: 1920 / 2,
          top: 1080 / 2,
          fontFamily: "sans-serif",
          fill: "#ffffff",
          dataId: "counter",
          counterName: counter,
        });
        addCustomProperties(text);
        canvas.add(text);
      }

      async function addImagePrompt() {
        const { value: url } = await Swal.fire({
          title: "Enter Image URL",
          input: "text",
          inputLabel: "image URL",
          showCancelButton: true,
          inputValidator: (value) => {
            if (!isValidUrl(value)) {
              return "Not a valid URL!";
            }
          },
        });
        if (!url) return;
        const img = getImage(url);
        canvas.add(img);
      }

      function addSubName() {
        const text = new fabric.IText("Subscriber", {
          left: 1920 / 2,
          top: 1080 / 2,
          fontFamily: "sans-serif",
          fill: "#ffffff",
          dataId: "latest_sub",
        });
        addCustomProperties(text);
        canvas.add(text);
      }

      function addCustomProperties(obj) {
        obj.controls.deleteControl = deleteControl;
      }

      function getImage(url) {
        const image = new Image();
        image.src = url;
        const obj = new fabric.FabricImage(image, {
          left: 1920 / 2,
          top: 1080 / 2,
        });
        obj.controls.deleteControl = deleteControl;
        return obj;
      }

      function addSubPfp() {
        const img = getImage(
          "https://static-cdn.jtvnw.net/user-default-pictures-uv/13e5fa74-defa-11e9-809c-784f43822e80-profile_image-300x300.png",
        );
        img.dataId = "sub_pfp";
        addCustomProperties(img);
        canvas.add(img);
      }

      async function sendToOverlay() {
        if (mode) {
          sendModtext();
          return;
        }
        const layoutData = canvas.toJSON();
        const response = await fetch("/control/modtext/setcanvas", {
          method: "POST",
          body: JSON.stringify(layoutData),
        });
        console.log(await response.text());
        console.log("Sent to Server:", layoutData);
      }

      async function sendModtext() {
        const html = textArea.value;
        textArea.value = html;

        const response = await fetch("/control/modtext/set", {
          method: "POST",
          body: html,
        });
        console.log(await response.text());
      }

      function toggleMode() {
        if (mode) {
          normalEditor.style.display = "block";
          textArea.style.display = "none";
        } else {
          normalEditor.style.display = "none";
          textArea.style.display = "block";
        }
        mode = !mode;
        document.querySelectorAll(".nerdMode").forEach((el) => {
          el.style.display = mode ? "inline" : "none";
        });

        document.querySelectorAll(".normalMode").forEach((el) => {
          el.style.display = mode ? "none" : "inline";
        });
      }

      async function getModTextdata() {
        try {
          const response = await fetch("/control/modtext/getdata");
          const responseJSON = await response.json();
          console.log("GOT DATA: ", responseJSON);
          data = responseJSON;
        } catch (e) {
          console.error(e);
        }
      }

      async function getModTextCanvas() {
        try {
          const response = await fetch("/control/modtext/getcanvas");
          const responseJSON = await response.json();
          console.log("GOT CANVAS:", responseJSON);
          await getModTextdata();
          await canvas
            .loadFromJSON(responseJSON, (_, obj) => addCustomProperties(obj))
            .then(() => canvas.renderAll());
          saveState();
        } catch (e) {
          console.error(e);
        }
      }

      async function getModText() {
        if (!mode) {
          await getModTextCanvas();
          return;
        }
        try {
          const response = await fetch("/control/modtext/get");
          const responseText = await response.text();
          if (!response.ok) {
            alert(`Error updating modtext ${responseText}`);
            return;
          }
          console.log("GOT MESSAGE:", responseText);
          textArea.value = responseText;
        } catch (e) {
          alert(`Error updating modtext ${e}`);
        }
      }
      function isValidUrl(string) {
        try {
          new URL(string);
          return true;
        } catch (err) {
          return false;
        }
      }

      function formatNumber(n) {
        return Number.isInteger(n) ? String(n) : String(Number(n.toFixed(2)));
      }
      async function pickImage() {
        loadImages();
        dialog.showModal();
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData(form);

        const res = await fetch(form.action, {
          method: "POST",
          body: formData,
        });

        if (!res.ok) {
          alert("Upload failed");
          return;
        }

        await loadImages();

        form.reset();
      });

      document.getElementById("cancelBtn").onclick = () => dialog.close();

      async function loadImages() {
        const res = await fetch("/control/modtext/getimages");
        const images = (await res.json()).map((i) => `/${i}`);

        grid.innerHTML = "";

        for (const url of images) {
          const img = document.createElement("img");
          img.src = url;
          img.onclick = () => {
            const img = getImage(url);
            canvas.add(img);
            dialog.close();
          };
          grid.appendChild(img);
        }
      }
      const undoStack = [];
      const redoStack = [];
      let isRestoring = false;

      function saveState() {
        if (isRestoring) return;

        redoStack.length = 0;
        undoStack.push(canvas.toJSON());

        if (undoStack.length > 50) {
          undoStack.shift();
        }
      }

      function undo() {
        if (undoStack.length < 2 || isRestoring) return;

        isRestoring = true;

        const current = undoStack.pop();
        redoStack.push(current);

        const previous = undoStack[undoStack.length - 1];
        canvas
          .loadFromJSON(previous, (_, obj) => addCustomProperties(obj))
          .then(() => {
            canvas.renderAll();
            isRestoring = false;
          });
      }

      function redo() {
        if (redoStack.length === 0) return;

        isRestoring = true;

        const state = redoStack.pop();
        undoStack.push(state);

        canvas
          .loadFromJSON(state, (_, obj) => addCustomProperties(obj))
          .then(() => {
            canvas.renderAll();
            isRestoring = false;
          });
      }

      window.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.key === "z") {
          e.preventDefault();
          undo();
        }

        if (e.ctrlKey && (e.key === "y" || (e.shiftKey && e.key === "Z"))) {
          e.preventDefault();
          redo();
        }
      });

      getModText().then(() => {
        events.forEach((event) => canvas.on(event, () => saveState()));
      });
    </script>
  </body>
</html>
